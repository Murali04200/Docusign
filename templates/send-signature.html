<!DOCTYPE html>
<html lang="en" data-bs-theme="light" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Send for Signature</title>

    <!-- Bootstrap + Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"/>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_parameter" th:content="${_csrf.parameterName}"/>

    <style>
        :root{
            --glass-bg: rgba(255,255,255,0.85);
            --accent: #4f46e5;
            --accent-2: #06b6d4;
            --muted: #6b7280;
        }

        body {
            background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 45%, #fbfbff 100%);
            min-height: 100vh;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            color: #0f172a;
        }

        .container { max-width: 1100px; }

        /* Layout: force equal height columns */
        .row.equal > [class*='col-'] { display: flex; align-items: stretch; }
        .glass-card {
            background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.82));
            border: 1px solid rgba(255,255,255,0.6);
            box-shadow: 0 10px 30px rgba(15,23,42,0.08);
            backdrop-filter: blur(8px) saturate(120%);
            -webkit-backdrop-filter: blur(8px) saturate(120%);
            border-radius: .85rem;
            transition: transform .18s ease, box-shadow .18s ease;
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        .glass-card:hover { transform: translateY(-4px); box-shadow: 0 20px 50px rgba(15,23,42,0.12); }

        .glass-card .card-body { flex: 1 1 auto; }

        .page-header { display:flex; gap:1rem; align-items:center; margin-bottom:1.25rem; }
        .brand-badge {
            width: 54px; height: 54px; border-radius: 14px;
            display: grid; place-items:center;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #fff; font-weight:600; font-size:1.05rem; box-shadow: 0 6px 18px rgba(79,70,229,0.18);
        }
        .page-title { margin:0; font-size:1.35rem; font-weight:700; }
        .page-sub { color: var(--muted); margin:0; font-size:.95rem; }

        .file-zone { display:grid; grid-template-columns: 1fr auto; gap:1rem; align-items:center; }
        .file-preview {
            border-radius: 8px;
            background: linear-gradient(180deg, rgba(15,23,42,0.02), rgba(15,23,42,0.01));
            padding:.75rem;
            min-height:88px;
            display:flex; align-items:center; gap:.75rem;
            border: 1px dashed rgba(15,23,42,0.06);
            overflow: hidden;
        }
        .file-thumb {
            width:64px; height:64px; border-radius:8px; display:grid; place-items:center; overflow:hidden; flex:0 0 64px;
            background: rgba(15,23,42,0.03);
        }
        .file-thumb img { width:100%; height:100%; object-fit:cover; display:block; }
        .file-meta { min-width: 0; } /* allow truncation */
        .file-meta .name { font-weight:600; font-size:.96rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

        .small-note { font-size:.875rem; color:var(--muted); }

        .recipient-row {
            background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,250,255,0.95));
            border: 1px solid rgba(15,23,42,0.06);
            border-radius:.6rem; padding:.85rem; transition: transform .12s ease, box-shadow .12s ease;
            display:flex; gap:.75rem; align-items:end;
        }
        .recipient-row:focus-within { outline: 2px solid rgba(59,130,246,0.12); box-shadow: 0 8px 24px rgba(59,130,246,0.04); }

        .recipient-actions .btn { min-width:44px; height:44px; display:grid; place-items:center; padding:0; border-radius:.5rem; }

        .btn-add {
            background: linear-gradient(90deg, rgba(79,70,229,0.12), rgba(6,182,212,0.08));
            border: 1px solid rgba(79,70,229,0.08);
            color: var(--accent);
        }

        input.form-control:focus, select.form-select:focus {
            border-color: rgba(79,70,229,0.8);
            box-shadow: 0 10px 30px rgba(79,70,229,0.06);
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent), var(--accent-2));
            border: none;
            box-shadow: 0 10px 30px rgba(79,70,229,0.12);
        }

        /* add animation for new recipient */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(12px) scale(0.995); }
            to   { opacity: 1; transform: translateY(0) scale(1); }
        }
        .animate-add { animation: slideUpFade .38s cubic-bezier(.2,.9,.2,1); }

        /* icons for file types */
        .icon-wrap { font-size: 1.6rem; color: rgba(15,23,42,0.6); }

        @media (max-width:767px) {
            .file-zone { grid-template-columns:1fr; }
            .recipient-row { flex-direction: column; align-items:stretch; }
            .recipient-row > div { width:100%; }
        }
    </style>
</head>

<body>
<div class="container py-4">

    <div class="page-header mb-4">
        <div class="brand-badge">DS</div>
        <div>
            <h3 class="page-title">Send for Signature</h3>
            <p class="page-sub">Upload document, add recipients and set permissions — simple and secure.</p>
        </div>
    </div>

    <form id="sendForm" class="needs-validation" novalidate enctype="multipart/form-data" method="post" action="/send-signature/next">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
        <input type="hidden" name="templateId" th:value="${templateId}" th:if="${templateId != null}">

        <div class="row g-4 equal">

            <!-- Upload column -->
            <div class="col-lg-6">
                <div class="glass-card card p-0">
                    <div class="card-header bg-transparent border-0 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-file-earmark-arrow-up-fill fs-4 text-primary me-2"></i>
                            <strong>1. Upload Document</strong>
                        </div>
                        <small class="small-note">Supported: PDF, DOC, DOCX, Images</small>
                    </div>

                    <div class="card-body">
                        <div class="file-zone mb-3">
                            <div class="file-preview" id="filePreview" aria-live="polite">
                                <div class="file-thumb" id="fileThumb">
                                    <i class="bi bi-file-earmark-fill icon-wrap" id="fileIcon"></i>
                                </div>
                                <div class="file-meta">
                                    <div class="name" id="fileName">No document selected</div>
                                    <div class="small-note" id="fileDetail">Choose a file to upload — preview or icon will appear here.</div>
                                </div>
                            </div>

                            <div class="d-grid gap-2">
                                <label class="btn btn-outline-primary mb-0" for="documentInput" id="chooseFileBtn">
                                    <i class="bi bi-upload me-1"></i> <span th:text="${preloadedFile != null ? 'Change file' : 'Choose file'}">Choose file</span>
                                </label>
                                <input id="documentInput" type="file" name="document" class="form-control d-none"
                                       accept="application/pdf,.doc,.docx,.png,.jpg,.jpeg"
                                       th:required="${preloadedFile == null}">
                                <div class="form-text small-note mt-1">Max size: 20MB</div>
                                <div class="invalid-feedback">Please select a document to continue.</div>
                            </div>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" value="true" id="allowEdit">
                            <label class="form-check-label small-note" for="allowEdit">Allow minor updates by signers (optional)</label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipients column -->
            <div class="col-lg-6">
                <div class="glass-card card p-0">
                    <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-people-fill fs-4 text-success me-2"></i>
                            <strong>2. Recipients & Permissions</strong>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="button" id="addRecipient" class="btn btn-sm btn-add d-flex align-items-center">
                                <i class="bi bi-person-plus me-2"></i> Add recipient
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <div id="recipients" class="d-grid gap-3">
                            <!-- recipient row template (first) -->
                            <div class="recipient-row d-flex gap-2 align-items-end mb-0">
                                <div class="flex-grow-1">
                                    <label class="form-label small-note mb-1">Full name</label>
                                    <input type="text" name="recipientName" class="form-control" placeholder="Ram" required>
                                    <div class="invalid-feedback">Name is required.</div>
                                </div>

                                <div class="flex-grow-1">
                                    <label class="form-label small-note mb-1">Email</label>
                                    <input type="email" name="recipientEmail" class="form-control" placeholder="ram@example.com" required>
                                    <div class="invalid-feedback">Valid email is required.</div>
                                </div>

                                <div style="min-width: 165px;">
                                    <label class="form-label small-note mb-1">Permission</label>
                                    <select name="permission" class="form-select" required>
                                        <option value="SIGN">Sign</option>
                                        <option value="VIEW">View</option>
                                        <option value="COPY">Receive Copy</option>
                                    </select>
                                </div>

                                <div class="recipient-actions d-flex align-items-center ms-2">
                                    <button type="button" class="btn btn-outline-danger" title="Remove" onclick="removeRecipient(this)">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="text-muted small mt-2">Add at least one recipient. You can set who must sign, who can view, or who receives a copy.</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-end mt-4">
            <a href="/dashboard" class="btn btn-outline-secondary me-2"><i class="bi bi-x-lg me-1"></i>Cancel</a>
            <button type="submit" class="btn btn-primary"><i class="bi bi-send-check-fill me-1"></i>Next</button>
        </div>
    </form>
</div>

<!-- Bootstrap JS bundle -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // File preview logic (image thumbnail or file icon)
    const inputFile = document.getElementById('documentInput');
    const fileNameEl = document.getElementById('fileName');
    const fileDetailEl = document.getElementById('fileDetail');
    const fileThumb = document.getElementById('fileThumb');
    const fileIcon = document.getElementById('fileIcon');

    inputFile && inputFile.addEventListener('change', (e) => {
        const f = e.target.files[0];
        if (!f) {
            resetPreview();
            return;
        }

        const type = f.type || '';
        const name = f.name || 'file';
        const sizeKB = Math.round(f.size / 1024);

        fileNameEl.textContent = name;
        fileDetailEl.textContent = `${sizeKB} KB • ${type || 'unknown'}`;

        // clear current thumb content
        fileThumb.innerHTML = '';

        if (type.startsWith('image/')) {
            // show image preview as thumbnail
            const img = document.createElement('img');
            img.src = URL.createObjectURL(f);
            img.onload = () => URL.revokeObjectURL(img.src);
            img.alt = name;
            fileThumb.appendChild(img);
        } else if (type === 'application/pdf' || name.toLowerCase().endsWith('.pdf')) {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-pdf-fill fs-2 text-danger"></i>';
        } else if (name.match(/\.docx?$/i)) {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-word-fill fs-2 text-primary"></i>';
        } else {
            // generic file icon
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-fill fs-2 text-muted"></i>';
        }
    });

    function resetPreview() {
        fileNameEl.textContent = 'No document selected';
        fileDetailEl.textContent = 'Choose a file to upload — preview or icon will appear here.';
        fileThumb.innerHTML = '<i class="bi bi-file-earmark-fill icon-wrap" id="fileIcon"></i>';
    }

    // Recipient add/remove with animation
    function removeRecipient(btn) {
        const container = document.getElementById('recipients');
        const rows = container.querySelectorAll('.recipient-row');
        const row = btn.closest('.recipient-row');
        if (rows.length > 1) {
            // animate removal
            row.style.transition = 'opacity .18s, transform .18s';
            row.style.opacity = '0';
            row.style.transform = 'translateY(8px) scale(.995)';
            setTimeout(() => row.remove(), 180);
        } else {
            // Clear fields if only one remains
            row.querySelectorAll('input').forEach(i => i.value = '');
            row.querySelector('select').selectedIndex = 0;
        }
    }

    document.getElementById('addRecipient').addEventListener('click', function() {
        const container = document.getElementById('recipients');
        const tpl = container.firstElementChild.cloneNode(true);

        // clear values on clone
        tpl.querySelectorAll('input').forEach(inp => { inp.value = ''; inp.classList.remove('is-invalid'); });
        const sel = tpl.querySelector('select'); if (sel) sel.selectedIndex = 0;

        // apply entrance animation class
        tpl.classList.add('animate-add');
        container.appendChild(tpl);

        // focus on the new name field
        const newName = tpl.querySelector('input[name="recipientName"]');
        if (newName) newName.focus();

        // remove animation class after it ends so future re-add works cleanly
        tpl.addEventListener('animationend', () => tpl.classList.remove('animate-add'), { once: true });
    });

    // Form validation and ensure arrays
    document.getElementById('sendForm').addEventListener('submit', function(e) {
        if (!this.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        this.classList.add('was-validated');

        // Ensure recipients are submitted as arrays (they already are, but normalize names)
        const names = this.querySelectorAll('input[name="recipientName"]');
        const emails = this.querySelectorAll('input[name="recipientEmail"]');
        const perms = this.querySelectorAll('select[name="permission"]');

        // (No renaming needed if server accepts repeated params; keep names as-is)
        names.forEach(n => n.name = 'recipientName');
        emails.forEach(em => em.name = 'recipientEmail');
        perms.forEach(p => p.name = 'permission');
    });

    // Initialize
    resetPreview();

    // Check if template is preloaded
    const preloadedTemplate = /*[[${template}]]*/ null;
    const isPreloaded = /*[[${preloadedFile}]]*/ false;

    if (isPreloaded && preloadedTemplate) {
        // Show template info in file preview
        const templateName = /*[[${template.name}]]*/ 'Template';
        const templateCategory = /*[[${template.category}]]*/ '';
        const templateType = /*[[${template.fileType}]]*/ 'PDF';

        fileNameEl.textContent = templateName;
        fileDetailEl.innerHTML = '<span class="badge bg-success me-2">Template</span>' + templateCategory;

        // Set appropriate icon based on file type
        fileThumb.innerHTML = '';
        if (templateType === 'PDF') {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-pdf-fill fs-2 text-danger"></i>';
        } else if (templateType === 'DOCX' || templateType === 'DOC') {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-word-fill fs-2 text-primary"></i>';
        } else if (templateType === 'XLSX' || templateType === 'XLS') {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-excel-fill fs-2 text-success"></i>';
        } else {
            fileThumb.innerHTML = '<i class="bi bi-file-earmark-fill fs-2 text-muted"></i>';
        }
    }
</script>
</body>
</html>
